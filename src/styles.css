/* Base styles */
:root {
  --bg: #0f1014;
  --panel: #1d2026;
  --accent: #ff9f43;
  --accent-glow: #ffb866;
  --locked: #555b66;
  --unlocked: #4caf50;
  --completed: #6ec6ff;
  --text: #f5f7fa;
  --danger: #ff4d4f;
  --focus: #ffee58;
  font-family: 'Segoe UI', system-ui, Arial, sans-serif;
}

html, body {
  margin: 0;
  padding: 0;
  /* Updated outer background color */
  background: #00a295;
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}
html, body { min-height: 100dvh; }

body { width:100%; min-height:100dvh; }
#app { position:relative; min-height:100dvh; display:flex; justify-content:center; padding:0 !important; margin:0 !important; }
/* Centered narrow game container; canvas keeps its intrinsic (renderer) size for crisp input mapping */
#pixi-root { border:none; box-shadow:none; border-radius:0; background:transparent; max-width:600px; width:100%; margin:0 auto; display:flex; align-items:stretch; }
/* Remove forced canvas scaling to avoid stretch */
#pixi-root canvas { display:block; height:auto !important; width:auto !important; }

/* Controls */
.controls {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 0.75rem;
  position:absolute; top:calc(8px + env(safe-area-inset-top)); right:calc(10px + env(safe-area-inset-right)); margin-top:0; justify-content:flex-end;
  z-index: 70; /* above fade overlay */
}
.controls button {
  background: var(--panel);
  border: 1px solid #37424e;
  padding: 0.65rem 1rem;
  border-radius: 10px;
  color: var(--text);
  cursor: pointer;
  font-size: 0.9rem;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  transition: background .25s, transform .25s;
  background:rgba(0,0,0,0.35); backdrop-filter:blur(4px); border:1px solid #3a454f;
}
.controls button:hover:not(:disabled) {
  background: #2c3642;
  transform: translateY(-2px);
}
.controls button:active:not(:disabled) {
  transform: translateY(0);
}
.controls button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}
.controls button.reset {
  color: var(--danger);
  color:#ff6b6e;
}
.controls button.reset:hover:not(:disabled) {
  background: #3a1d1f;
}
.token-counter { display:inline-flex; align-items:center; gap:.4rem; background:rgba(0,0,0,0.5); padding:.45rem .65rem; border-radius:12px; border:1px solid #2e3b47; font-weight:600; font-size:.9rem; line-height:1; box-shadow:0 2px 6px -2px rgba(0,0,0,.6); }
.token-counter .token-icon { width:24px; height:24px; display:block; filter:drop-shadow(0 1px 2px rgba(0,0,0,0.6)); }
.token-counter .token-count { min-width:1.2ch; text-align:right; font-variant-numeric:tabular-nums; }
@media (max-width: 640px) {
  #app { padding:0 !important; }
  #pixi-root { border-radius:0; }
  .controls button { font-size: .8rem; padding: .55rem .85rem; }
  .token-counter { font-size:.75rem; padding:.4rem .55rem; }
  .token-counter .token-icon { width:20px; height:20px; }
}

/* Compact reset button (top-left) */
.reset-fab {
  position:fixed;
  left:calc(10px + env(safe-area-inset-left));
  top:calc(10px + env(safe-area-inset-top));
  z-index:120; /* above controls */
  background:#402c2c;
  color:#fff;
  border:1px solid #6a3d3d;
  padding:.45rem .7rem;
  font-size:.75rem;
  font-weight:600;
  letter-spacing:.5px;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 4px 10px -4px rgba(0,0,0,0.55);
  transition:background .25s, transform .25s;
}
.reset-fab:hover { background:#5a2e2e; transform:translateY(-2px); }
.reset-fab:active { transform:translateY(0); }
@media (min-width: 900px){
  .reset-fab { font-size:.7rem; }
}

/* Modal */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(18px, env(safe-area-inset-bottom) + 6px) max(12px, env(safe-area-inset-left));
  backdrop-filter: blur(6px);
  z-index: 900; /* above dice bar (72) and nav-fab (75) */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.modal {
  background: linear-gradient(145deg,#1f2732,#12161c);
  border: 1px solid #2e3b47;
  border-radius: 18px;
  width: min(420px, 100%);
  max-width: 100%;
  box-sizing: border-box;
  padding: 1.15rem 1.2rem 1.25rem;
  box-shadow: 0 12px 34px -8px rgba(0,0,0,0.75), 0 0 0 1px #2e3b47 inset;
  position: relative;
  animation: popIn 0.45s cubic-bezier(.34,1.56,.64,1);
  max-height: calc(100dvh - 40px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.modal > .legend-list,
.modal > .body,
.modal .tutor-text,
.modal .tutor-copy,
.modal .minigame,
.modal .multi-body,
.modal .minigame .result {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.modal .body, .modal .multi-body, .modal .legend-list { flex: 1 1 auto; }
.modal .modal-footer { flex: 0 0 auto; }

body.modal-open { overflow: hidden; touch-action:none; }
body.modal-open #pixi-root { pointer-events: none; }
.modal h2 {
  margin-top: 0;
  font-weight: 600;
  letter-spacing: 0.5px;
}
.modal .close-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: transparent;
  border: none;
  color: #aaa;
  font-size: 1.25rem;
  cursor: pointer;
  line-height: 1;
}
.modal .close-btn:hover { color: #fff; }
.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  margin-top: 1.5rem;
}
.modal-footer button.primary {
  background: var(--accent);
  color: #222;
  font-weight: 600;
  border: none;
}
.modal-footer button.primary:hover {
  background: var(--accent-glow);
}

@keyframes popIn {
  0% { transform: scale(.8) translateY(10px); opacity: 0; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}

@media (max-width: 680px) {
  #pixi-root { max-width: 100%; border-radius:14px; }
}

/* Narrow phone refinements */
@media (max-width: 560px) {
  .modal { border-radius:16px; padding: 0.9rem 0.95rem 1rem; width:100%; }
  .modal h2 { font-size:1.1rem; }
  .modal p, .modal li, .modal .body, .modal .tutor-text, .modal .tutor-copy { font-size:.85rem; line-height:1.45; }
  .modal .modal-footer { margin-top:1.1rem; }
  .modal .modal-footer button { font-size:.8rem; padding:.55rem .9rem; }
  .tutor-speech-inner { font-size:.85rem; }
  .tutor-speech-inner h2 { font-size:1.15rem; }
}

/* Respect landscape on very short heights */
@media (max-height: 540px) and (orientation: landscape) {
  .modal-backdrop { align-items:stretch; }
  .modal { max-height: calc(100dvh - 24px); }
}

.fade-top { pointer-events:none; transition:opacity .4s ease; z-index:30; }
.fade-top::after { display:none; }

/* Floating recenter button */
.nav-fab {
  position: fixed;
  right: calc(18px + env(safe-area-inset-right));
  bottom: calc(18px + env(safe-area-inset-bottom));
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(0,0,0,0.55);
  color: #fff;
  border: 1px solid #2e3b47;
  font-size: 1.35rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 14px -4px rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  transition: background .25s, transform .25s;
  z-index: 75;
}
.nav-fab:hover { background: rgba(0,0,0,0.7); transform: translateY(-3px); }
.nav-fab:active { transform: translateY(0); }
@media (max-width: 640px) {
  .nav-fab { right: calc(12px + env(safe-area-inset-right)); bottom: calc(12px + env(safe-area-inset-bottom)); width: 44px; height: 44px; font-size:1.2rem; }
}

/* Dice bar */
.dice-bar {
  position: fixed;
  left: 50%;
  bottom: calc(10px + env(safe-area-inset-bottom));
  transform: translateX(-50%);
  z-index: 72; /* above fade */
  display: flex;
  justify-content: center;
  pointer-events: none; /* container ignores so internal buttons manage events */
  width: 100%;
  max-width: 640px;
  padding: 0 12px calc(env(safe-area-inset-bottom));
}
.dice-bar .dice-wrapper {
  pointer-events: auto;
  display: flex;
  gap: 0.75rem;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(8px);
  border: 1px solid #2e3b47;
  padding: 0.6rem 0.9rem;
  border-radius: 14px;
  align-items: center;
  box-shadow: 0 4px 16px -4px rgba(0,0,0,0.55);
}
.dice-roll-btn {
  background: var(--accent);
  color: #222;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  padding: 0.55rem 1.1rem;
  cursor: pointer;
  transition: background .25s, transform .2s;
}
.dice-roll-btn:hover:not(:disabled) { background: var(--accent-glow); }
.dice-roll-btn:active:not(:disabled) { transform: translateY(1px); }
.dice-roll-btn:disabled { opacity: .55; cursor: not-allowed; }
.dice-face {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  background: #12161c;
  border: 1px solid #2e3b47;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  font-weight: 600;
  color: #fff;
  box-shadow: inset 0 2px 4px -2px rgba(255,255,255,0.15), 0 2px 5px -2px rgba(0,0,0,0.7);
  font-variant-numeric: tabular-nums;
}
@media (max-width: 640px) {
  .dice-bar .dice-wrapper { gap: .6rem; padding: .5rem .7rem; }
  .dice-roll-btn { font-size: .8rem; padding: .45rem .85rem; }
  .dice-face { width: 38px; height: 38px; font-size: 1rem; }
}
